---
title: "SSB ban - full sim"
author: "Sanjay Basu"
date: "6/4/2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
# install.packages('tidyverse', repos='http://cran.us.r-project.org')
# install.packages('nhanesA', repos='http://cran.us.r-project.org')
# install.packages('furrr', repos='http://cran.us.r-project.org')
# install.packages('mice', repos='http://cran.us.r-project.org')
# install.packages('matrixStats', repos='http://cran.us.r-project.org')
# install.packages('svMisc', repos='http://cran.us.r-project.org')

library(tidyverse)
library(nhanesA)
library(furrr)
library(mice)
library(matrixStats)
library(svMisc)
```

## NHANES import

extract and define needed variables from NHANES 2011-2016
note the CKD-EPI equation is used to define CKD, http://nephron.com/epi_equation ; our justification for this decision was the results from: https://jamanetwork.com/journals/jama/fullarticle/1151529

```{r NHANES 2011-2012}
demo_g = nhanes('DEMO_G') %>%
  mutate(age = RIDAGEYR,
         female = (RIAGENDR==2),
         white = (RIDRETH3==3),
         black = (RIDRETH3==4),
         asian = (RIDRETH3==6),
         other = ((RIDRETH3!=3)&(RIDRETH3!=4)&(RIDRETH3!=6)),
         hisp = (RIDRETH3<=2)) %>%
  select(SEQN, age, female, white, black, asian, other, hisp)
hiq_g = nhanes('HIQ_G') %>%
  mutate(privins = (HIQ031A==14),
         privins = replace_na(privins, 0)) %>%
  select(SEQN, privins)
ocq_g = nhanes('OCQ_G') %>%
  filter((OCD231 <21)&(OCD150 ==1)) %>%
  mutate(mgmt = (OCD241<=7),
         blcol = (((OCD241>=12)&(OCD241<=15))|((OCD241>=18)&(OCD241<=22))),
         whcol = (((OCD241>=8)&(OCD241<=11))|((OCD241>=16)&(OCD241<=17)))) %>%
  select(SEQN, mgmt, blcol, whcol)
bmx_g = nhanes('BMX_G') %>%
  mutate(bmi = BMXBMI,
         wtkg = BMXWT,
         htm = BMXHT/100) %>%
  select(SEQN, bmi, wtkg, htm)
mcq_g = nhanes('MCQ_G') %>%
  mutate(chd = (MCQ160B==1)|(MCQ160C==1)|(MCQ160D==1)|(MCQ160E==1),
         str = (MCQ160F==1)) %>%
  select(SEQN, chd, str)
rxq_drug = nhanes('RXQ_DRUG') 
rxq_rx_g = nhanes('RXQ_RX_G') %>%
  left_join(rxq_drug, by = "RXDDRGID") %>%
  filter(RXDDCN1B=="ANTIDIABETIC AGENTS") %>%
  group_by(SEQN) %>%
  mutate(dmmed = 1) %>%
  select(SEQN,dmmed)
ghb_g = nhanes('GHB_G') %>%
  select(SEQN, LBXGH)
glu_g = nhanes('GLU_G') %>%
  select(SEQN, LBXGLU)
ogtt_g = nhanes('OGTT_G') %>%
  select(SEQN, LBXGLT)
diq_g = nhanes('DIQ_G') %>%
  full_join(ghb_g, by="SEQN") %>%
  full_join(glu_g, by="SEQN") %>%
  full_join(ogtt_g, by="SEQN") %>%
  full_join(rxq_rx_g, by="SEQN") %>%
  mutate(dm = ((LBXGH>=6.5)|(LBXGLU>=126)|(LBXGLT>=200)|(DIQ010==1)|(dmmed==1)),
         dm = replace_na(dm, 0)) %>%
  select(SEQN,dm)
biopro_g = nhanes('BIOPRO_G') %>%
  select(SEQN, LBXSCR)
kiq_u_g = nhanes('KIQ_U_G') %>%
  full_join(biopro_g, by="SEQN") %>%
  full_join(demo_g, by="SEQN") %>%
  mutate(scr = LBXSCR,
         kappa = 0.7*female + 0.9 *(1-female),
         alpha = -0.329*female -0.411*(1-female),
         sk = scr/kappa,
         minsk = sk*(sk<1)+1*(sk>=1),
         maxsk = sk*(sk>=1)+1*(sk<1),
         egfr = 141 *(minsk^alpha) *  
           (maxsk^(-1.209))*
           (0.993^age)*
           (1.018*female+1*(1-female))*
           (1.159*black+1*(1-black)),
         ckd = (egfr<90)) %>%
  select(SEQN, ckd)
ohxref_g = nhanes('OHXREF_G') %>%
  mutate(dental = (OHAROCDT==1)&(OHAROCGP==1)) %>%
  select(SEQN, dental)
```

```{r NHANES 2013-2014}
demo_h = nhanes('DEMO_H') %>%
  mutate(age = RIDAGEYR,
         female = (RIAGENDR==2),
         white = (RIDRETH3==3),
         black = (RIDRETH3==4),
         asian = (RIDRETH3==6),
         other = ((RIDRETH3!=3)&(RIDRETH3!=4)&(RIDRETH3!=6)),
         hisp = (RIDRETH3<=2)) %>%
  select(SEQN, age, female, white, black, asian, other, hisp)
hiq_h = nhanes('HIQ_H') %>%
  mutate(privins = (HIQ031A==14),
         privins = replace_na(privins, 0)) %>%
  select(SEQN, privins)
ocq_h = nhanes('OCQ_H') %>%
  filter((OCQ260 ==1)&(OCD150 ==1)) %>%
  mutate(mgmt = NA,
         blcol = NA,
         whcol = NA) %>%
  select(SEQN, mgmt, blcol, whcol)
bmx_h = nhanes('BMX_H') %>%
  mutate(bmi = BMXBMI,
         wtkg = BMXWT,
         htm = BMXHT/100) %>%
  select(SEQN, bmi, wtkg, htm)
mcq_h = nhanes('MCQ_H') %>%
  mutate(chd = (MCQ160B==1)|(MCQ160C==1)|(MCQ160D==1)|(MCQ160E==1),
         str = (MCQ160F==1)) %>%
  select(SEQN, chd, str)
rxq_drug = nhanes('RXQ_DRUG') 
rxq_rx_h = nhanes('RXQ_RX_H') %>%
  left_join(rxq_drug, by = "RXDDRGID") %>%
  filter(RXDDCN1B=="ANTIDIABETIC AGENTS") %>%
  group_by(SEQN) %>%
  mutate(dmmed = 1) %>%
  select(SEQN,dmmed)
ghb_h = nhanes('GHB_H') %>%
  select(SEQN, LBXGH)
glu_h = nhanes('GLU_H') %>%
  select(SEQN, LBXGLU)
ogtt_h = nhanes('OGTT_H') %>%
  select(SEQN, LBXGLT)
diq_h = nhanes('DIQ_H') %>%
  full_join(ghb_h, by="SEQN") %>%
  full_join(glu_h, by="SEQN") %>%
  full_join(ogtt_h, by="SEQN") %>%
  full_join(rxq_rx_h, by="SEQN") %>%
  mutate(dm = ((LBXGH>=6.5)|(LBXGLU>=126)|(LBXGLT>=200)|(DIQ010==1)|(dmmed==1)),
         dm = replace_na(dm, 0)) %>%
  select(SEQN,dm)
biopro_h = nhanes('BIOPRO_H') %>%
  select(SEQN, LBXSCR)
kiq_u_h = nhanes('KIQ_U_H') %>%
  full_join(biopro_h, by="SEQN") %>%
  full_join(demo_h, by="SEQN") %>%
  mutate(scr = LBXSCR,
         kappa = 0.7*female + 0.9 *(1-female),
         alpha = -0.329*female -0.411*(1-female),
         sk = scr/kappa,
         minsk = sk*(sk<1)+1*(sk>=1),
         maxsk = sk*(sk>=1)+1*(sk<1),
         egfr = 141 *(minsk^alpha) *
           (maxsk^(-1.209))*
           (0.993^age)*
           (1.018*female+1*(1-female))*
           (1.159*black+1*(1-black)),
         ckd = (egfr<90)) %>%
  select(SEQN, ckd)
ohxref_h = nhanes('OHXREF_H') %>%
  mutate(dental = (OHAROCDT==1)&(OHAROCGP==1)) %>%
  select(SEQN, dental)
```

```{r NHANES 2015-2016}
demo_i = nhanes('DEMO_I') %>%
  mutate(age = RIDAGEYR,
         female = (RIAGENDR==2),
         white = (RIDRETH3==3),
         black = (RIDRETH3==4),
         asian = (RIDRETH3==6),
         other = ((RIDRETH3!=3)&(RIDRETH3!=4)&(RIDRETH3!=6)),
         hisp = (RIDRETH3<=2)) %>%
  select(SEQN, age, female, white, black, asian, other, hisp)
hiq_i = nhanes('HIQ_I') %>%
  mutate(privins = (HIQ031A==14),
         privins = replace_na(privins, 0)) %>%
  select(SEQN, privins)
ocq_i = nhanes('OCQ_I') %>%
  filter((OCQ260 ==1)&(OCD150 ==1)) %>%
  mutate(mgmt = NA,
         blcol = NA,
         whcol = NA) %>%
  select(SEQN, mgmt, blcol, whcol)
bmx_i = nhanes('BMX_I') %>%
  mutate(bmi = BMXBMI,
         wtkg = BMXWT,
         htm = BMXHT/100) %>%
  select(SEQN, bmi, wtkg, htm)
mcq_i = nhanes('MCQ_I') %>%
  mutate(chd = (MCQ160B==1)|(MCQ160C==1)|(MCQ160D==1)|(MCQ160E==1),
         str = (MCQ160F==1)) %>%
  select(SEQN, chd, str)
rxq_drug = nhanes('RXQ_DRUG') 
rxq_rx_i = nhanes('RXQ_RX_I') %>%
  left_join(rxq_drug, by = "RXDDRGID") %>%
  filter(RXDDCN1B=="ANTIDIABETIC AGENTS") %>%
  group_by(SEQN) %>%
  mutate(dmmed = 1) %>%
  select(SEQN,dmmed)
ghb_i = nhanes('GHB_I') %>%
  select(SEQN, LBXGH)
glu_i = nhanes('GLU_I') %>%
  select(SEQN, LBXGLU)
ogtt_i = nhanes('OGTT_I') %>%
  select(SEQN, LBXGLT)
diq_i = nhanes('DIQ_I') %>%
  full_join(ghb_i, by="SEQN") %>%
  full_join(glu_i, by="SEQN") %>%
  full_join(ogtt_i, by="SEQN") %>%
  full_join(rxq_rx_i, by="SEQN") %>%
  mutate(dm = ((LBXGH>=6.5)|(LBXGLU>=126)|(LBXGLT>=200)|(DIQ010==1)|(dmmed==1)),
         dm = replace_na(dm, 0)) %>%
  select(SEQN,dm)
biopro_i = nhanes('BIOPRO_I') %>%
  select(SEQN, LBXSCR)
kiq_u_i = nhanes('KIQ_U_I') %>%
  full_join(biopro_i, by="SEQN") %>%
  full_join(demo_i, by="SEQN") %>%
  mutate(scr = LBXSCR,
         kappa = 0.7*female + 0.9 *(1-female),
         alpha = -0.329*female -0.411*(1-female),
         sk = scr/kappa,
         minsk = sk*(sk<1)+1*(sk>=1),
         maxsk = sk*(sk>=1)+1*(sk<1),
         egfr = 141 *(minsk^alpha) *
           (maxsk^(-1.209))*
           (0.993^age)*
           (1.018*female+1*(1-female))*
           (1.159*black+1*(1-black)),
         ckd = (egfr<90)) %>%
  select(SEQN, ckd)
ohxref_i = nhanes('OHXREF_I') %>%
  mutate(dental = (OHAROCDT==1)&(OHAROCGP==1)) %>%
  select(SEQN, dental)
```

## NHANES join

join and limit to employed pop by occ class, starting with ocq and left joins to limit to those employed in priv sec

```{r NHANES data joins}

nhanes11 = ocq_g %>%
  left_join(demo_g, by="SEQN") %>%
  left_join(hiq_g, by="SEQN") %>%
  left_join(bmx_g, by="SEQN") %>%
  left_join(mcq_g, by="SEQN") %>%
  left_join(diq_g, by="SEQN") %>%
  left_join(kiq_u_g, by="SEQN") %>%
  left_join(ohxref_g, by="SEQN")

nhanes13 = ocq_h %>%
  left_join(demo_h, by="SEQN") %>%
  left_join(hiq_h, by="SEQN") %>%
  left_join(bmx_h, by="SEQN") %>%
  left_join(mcq_h, by="SEQN") %>%
  left_join(diq_h, by="SEQN") %>%
  left_join(kiq_u_h, by="SEQN") %>%
  left_join(ohxref_h, by="SEQN")  

nhanes15 = ocq_i %>%
  left_join(demo_i, by="SEQN") %>%
  left_join(hiq_i, by="SEQN") %>%
  left_join(bmx_i, by="SEQN") %>%
  left_join(mcq_i, by="SEQN") %>%
  left_join(diq_i, by="SEQN") %>%
  left_join(kiq_u_i, by="SEQN") %>%
  left_join(ohxref_i, by="SEQN")

nhanes = bind_rows(list(nhanes11, nhanes13, nhanes15))
summary(nhanes)
```

## Imputation

multiple imputation w/ chained equations

```{r imputation}
set.seed(123)
plan(multiprocess)
start = Sys.time()
imp_nhanes = future_map(rep(1, 5), ~mice(data = nhanes, m = ., maxit = 100, printFlag = FALSE))
end = Sys.time() - start
print(end)
imp_nhanes_complete = map(imp_nhanes, mice::complete)
imp_nhanes = map2(.x = seq(1,5), .y = imp_nhanes_complete, ~mutate(.y, imp_id = as.character(.x)))
imp_nhanes = bind_rows(imp_nhanes)
summary(imp_nhanes)


```
# calculate costs on 10 year and lifetime horizons
simulate people aging and getting incident conditions, then mortality
calculate cost and QALYs per prevalent conditions x years of those conditions
people in rows, condition for each year in columns
if person already has condition in current year, they continue to have condition in future years, except for dental [which recurs per annum]
IHME input data, from https://vizhub.healthdata.org/gbd-compare/
incidence and mortality organized as: male age 15-49, female age 15-49, male age 50-69, female age 50-69, male age 70+, female age 70+
delta: RRR after SSB ban

```{r import from NHANES.R}
yrs = 100

alive = matrix(1,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_obese = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_chd = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_str = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_dm = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_ckd = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_den = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
alive_post = matrix(1,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_obese_post = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_chd_post = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_str_post = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_dm_post = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_ckd_post = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)
prev_den_post = matrix(0,nrow=length(imp_nhanes$SEQN),ncol=yrs)

prev_obese[,1:yrs] = (imp_nhanes$bmi>=30)
prev_chd[,1:yrs] = (imp_nhanes$chd==1)
prev_str[,1:yrs] = (imp_nhanes$str==1)
prev_dm[,1:yrs] = (imp_nhanes$dm==1)
prev_ckd[,1:yrs] = (imp_nhanes$ckd==1)
prev_den[,1] = (imp_nhanes$dental==1)

prev_obese_post[,1:yrs] = (imp_nhanes$bmi>=30)
prev_chd_post[,1:yrs] = (imp_nhanes$chd==1)
prev_str_post[,1:yrs] = (imp_nhanes$str==1)
prev_dm_post[,1:yrs] = (imp_nhanes$dm==1)
prev_ckd_post[,1:yrs] = (imp_nhanes$ckd==1)
prev_den_post[,1] = (imp_nhanes$dental==1)

wt_delta_peryr = coef(lm(imp_nhanes$wtkg ~ imp_nhanes$age))[2]

inc_chd = c(84.73, 35.32, 749.99, 334.72, 1928.63, 1326.84)/1e5
inc_str = c(39.46, 39.85, 293.61, 243.91, 932.11, 986.96)/1e5
inc_dm = c(1.5, 1, 29, 17.73, 298.95, 199)/1e5
inc_ckd = c(63.6, 98.7, 757.26, 796.03, 2096.14, 2245.7)/1e5
inc_den = c(44725, 45662, 23326, 24596, 16996, 17104)/1e5

mort_obese = c(19.99, 9.8, 224.5, 130.44, 711.26, 762.99)/1e5
mort_chd = c(16.12, 6.07, 222.08, 89.68, 1307.88, 1098.13)/1e5
mort_str = c(4.03, 3.3, 45.28, 32.27, 370.56, 440.72)/1e5
mort_dm = c(1.5, 1, 29, 17.73, 121.65, 98.42)/1e5
mort_ckd = c(2.56, 1.8, 29.07, 20.89, 209.09, 169.07)/1e5
mort_all = c(205, 109, 1139, 711, 5936, 5351)/1e5 

delta_ssb = 1.5 # ounces/person/day
cals_per_ounce = 11.7 # calories/ounce SSBs
delta_wtkg = delta_ssb*cals_per_ounce*1/10*0.453592 # 10 calories = 1 pound = 0.45 kg, https://www.healthaffairs.org/doi/full/10.1377/hlthaff.2011.0410
delta_chd = (1-0.023/37*29.57353*delta_ssb) # 0.023 for 37ml, 29.57353 mL per ounce, https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1002158#sec018
delta_str = (1-0.011/37*29.57353*delta_ssb) # 0.011 for 37ml, 29.57353 mL per ounce, https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1002158#sec018
delta_dm = (1-0.18/250*29.57*delta_ssb) # 0.18 for 250 ml
delta_ckd = (1-0.20/12*delta_ssb) # 0.20 for serving
delta_den = (1-0.30/12*delta_ssb) # 0.20 for serving
delta_mort = (1-0.17/12*delta_ssb) # 0.24 for 12oz serving
```

```{r iters}
iters = 1000
attach(imp_nhanes)
n= length(imp_nhanes$SEQN)
tot_qalys_10 = rep(0,10000)
tot_costs_10 = rep(0,10000)
tot_qalys_lt = rep(0,10000)
tot_costs_lt = rep(0,10000)

tot_qalys_10_post = rep(0,10000)
tot_costs_10_post = rep(0,10000)
tot_qalys_lt_post = rep(0,10000)
tot_costs_lt_post = rep(0,10000)

icer_10 = rep(0,10000)
icer_lt = rep(0,10000)


set.seed(100)
start = Sys.time()

for (j in 1:iters){
  progress(j, progress.bar = T)
  age = imp_nhanes$age
for (i in 2:yrs){
  age = age+1
  
  # add new incidence to prevalence
  prev_obese[,i] = (((wtkg+wt_delta_peryr*i)/(htm^2))>=30)
  prev_obese_post[,i] = (((wtkg-delta_wtkg+wt_delta_peryr*i)/(htm^2))>=30)
  
  prob_chd = (age>=15)*(age<=49)*(female==0)*inc_chd[1]+
    (age>=15)*(age<=49)*(female==1)*inc_chd[2]+
    (age>=50)*(age<=69)*(female==0)*inc_chd[3]+
    (age>=50)*(age<=69)*(female==1)*inc_chd[4]+
    (age>=70)*(female==0)*inc_chd[5]+
    (age>=70)*(female==1)*inc_chd[6]
  prev_chd[,i] = rowMaxs(cbind(prev_chd[,(i-1)], rbinom(n, 1, prob_chd)))
  prev_chd_post[,i] = rowMaxs(cbind(prev_chd[,(i-1)], rbinom(n, 1, prob_chd*delta_chd)))
  
  prob_str = (age>=15)*(age<=49)*(female==0)*inc_str[1]+
    (age>=15)*(age<=49)*(female==1)*inc_str[2]+
    (age>=50)*(age<=69)*(female==0)*inc_str[3]+
    (age>=50)*(age<=69)*(female==1)*inc_str[4]+
    (age>=70)*(female==0)*inc_str[5]+
    (age>=70)*(female==1)*inc_str[6]
  prev_str[,i] = rowMaxs(cbind(prev_str[,(i-1)], rbinom(n, 1, prob_str)))
  prev_str_post[,i] = rowMaxs(cbind(prev_str[,(i-1)], rbinom(n, 1, prob_str*delta_str)))
  
  prob_dm = (age>=15)*(age<=49)*(female==0)*inc_dm[1]+
    (age>=15)*(age<=49)*(female==1)*inc_dm[2]+
    (age>=50)*(age<=69)*(female==0)*inc_dm[3]+
    (age>=50)*(age<=69)*(female==1)*inc_dm[4]+
    (age>=70)*(female==0)*inc_dm[5]+
    (age>=70)*(female==1)*inc_dm[6]
  prev_dm[,i] = rowMaxs(cbind(prev_dm[,(i-1)], rbinom(n, 1, prob_dm)))
  prev_dm_post[,i] = rowMaxs(cbind(prev_dm[,(i-1)], rbinom(n, 1, prob_dm*delta_dm)))
  
  prob_ckd = (age>=15)*(age<=49)*(female==0)*inc_ckd[1]+
    (age>=15)*(age<=49)*(female==1)*inc_ckd[2]+
    (age>=50)*(age<=69)*(female==0)*inc_ckd[3]+
    (age>=50)*(age<=69)*(female==1)*inc_ckd[4]+
    (age>=70)*(female==0)*inc_ckd[5]+
    (age>=70)*(female==1)*inc_ckd[6]
  prev_ckd[,i] = rowMaxs(cbind(prev_ckd[,(i-1)], rbinom(n, 1, prob_ckd)))
  prev_ckd_post[,i] = rowMaxs(cbind(prev_ckd[,(i-1)], rbinom(n, 1, prob_ckd*delta_ckd)))
  
  prob_den = (age>=15)*(age<=49)*(female==0)*inc_den[1]+
    (age>=15)*(age<=49)*(female==1)*inc_den[2]+
    (age>=50)*(age<=69)*(female==0)*inc_den[3]+
    (age>=50)*(age<=69)*(female==1)*inc_den[4]+
    (age>=70)*(female==0)*inc_den[5]+
    (age>=70)*(female==1)*inc_den[6]
  prev_den[,i] = rbinom(n, 1, prob_den) # dental prev is annual
  prev_den_post[,i] = rbinom(n, 1, prob_den*delta_den) 
  
  # track mortality including co-morbid risks by calculating mort risk by indiv given additivity
  prob_mort = (age>=15)*(age<=49)*(female==0)*(mort_obese[1]*prev_obese[,i]+mort_chd[1]*prev_chd[,i]+mort_str[1]*prev_str[,i]+mort_dm[1]*prev_dm[,i]+mort_ckd[1]*prev_ckd[,i]+mort_all[1])+
    (age>=15)*(age<=49)*(female==1)*((mort_obese[2]*prev_obese[,i]+mort_chd[2]*prev_chd[,i]+mort_str[2]*prev_str[,i]+mort_dm[2]*prev_dm[,i]+mort_ckd[2]*prev_ckd[,i]+mort_all[2]))+
    (age>=50)*(age<=69)*(female==0)*((mort_obese[3]*prev_obese[,i]+mort_chd[3]*prev_chd[,i]+mort_str[3]*prev_str[,i]+mort_dm[3]*prev_dm[,i]+mort_ckd[3]*prev_ckd[,i]+mort_all[3]))+
    (age>=50)*(age<=69)*(female==1)*((mort_obese[4]*prev_obese[,i]+mort_chd[4]*prev_chd[,i]+mort_str[4]*prev_str[,i]+mort_dm[4]*prev_dm[,i]+mort_ckd[4]*prev_ckd[,i]+mort_all[4]))+
    (age>=70)*(female==0)*((mort_obese[5]*prev_obese[,i]+mort_chd[5]*prev_chd[,i]+mort_str[5]*prev_str[,i]+mort_dm[5]*prev_dm[,i]+mort_ckd[5]*prev_ckd[,i]+mort_all[5]))+
    (age>=70)*(female==1)*((mort_obese[6]*prev_obese[,i]+mort_chd[6]*prev_chd[,i]+mort_str[6]*prev_str[,i]+mort_dm[6]*prev_dm[,i]+mort_ckd[6]*prev_ckd[,i]+mort_all[6]))
  alive[,i] = rowMins(cbind(alive[,(i-1)], 1-rbinom(n, 1, prob_mort)))
  alive_post[,i] = rowMins(cbind(alive_post[,(i-1)], 1-rbinom(n, 1, prob_mort*delta_mort)))
  
}


# estimate QALYS, discounted, then cost from MEPS, discounted
#obesity disutil from Table 2 from: https://asmbs.org/app/uploads/2011/05/tseng-cea.pdf
#other utils from Table 2 of : https://www.thelancet.com/action/showPdf?pii=S2214-109X%2815%2900069-8
#w/ weighting by duration for acute episodes and equal probabilities across condition severity
#based on RECODe equations, typically 12% risk of nephropathy, 6% retinopathy, and 8% neuropathy for this pop
#CKD by stage


util_obese = matrix(c(0.929,0.912,0.886,0.85,0.805,0.908,0.889,0.857,0.813,0.755,
                      0.903,0.88,0.853,0.823,0.79,0.875,0.846,0.811,0.77,0.722,
                      0.877,0.848,0.821,0.797,0.775,0.842,0.804,0.765,0.727,0.688,
                      0.851,0.816,0.789,0.77,0.76,0.809,0.761,0.719,0.684,0.654,
                      0.825,0.784,0.756,0.743,0.745,0.775,0.718,0.673,0.641,0.621,
                      0.799,0.752,0.724,0.717,0.73,0.742,0.675,0.627,0.598,0.587),ncol=10,nrow=6)


dist_obese = matrix(c(sum((bmi>=25)&(bmi<=27.5)&(age>40)&(female==0)), sum((bmi>=25)&(bmi<=27.5)&(age>40)&(age<=50)&(female==0)), sum((bmi>=25)&(bmi<=27.5)&(age>50)&(age<=60)&(female==0)), sum((bmi>=25)&(bmi<=27.5)&(age>60)&(age<=70)&(female==0)), sum((bmi>=25)&(bmi<=27.5)&(age>70)&(female==0)),
                      sum((bmi>=25)&(bmi<=27.5)&(age>40)&(female==1)), sum((bmi>=25)&(bmi<=27.5)&(age>40)&(age<=50)&(female==1)), sum((bmi>=25)&(bmi<=27.5)&(age>50)&(age<=60)&(female==1)), sum((bmi>=25)&(bmi<=27.5)&(age>60)&(age<=70)&(female==1)), sum((bmi>=25)&(bmi<=27.5)&(age>70)&(female==1)),
                      sum((bmi>=27.5)&(bmi<=32.5)&(age>40)&(female==0)), sum((bmi>=27.5)&(bmi<=32.5)&(age>40)&(age<=50)&(female==0)), sum((bmi>=27.5)&(bmi<=32.5)&(age>50)&(age<=60)&(female==0)), sum((bmi>=27.5)&(bmi<=32.5)&(age>60)&(age<=70)&(female==0)), sum((bmi>=27.5)&(bmi<=32.5)&(age>70)&(female==0)),
                      sum((bmi>=27.5)&(bmi<=32.5)&(age>40)&(female==1)), sum((bmi>=27.5)&(bmi<=32.5)&(age>40)&(age<=50)&(female==1)), sum((bmi>=27.5)&(bmi<=32.5)&(age>50)&(age<=60)&(female==1)), sum((bmi>=27.5)&(bmi<=32.5)&(age>60)&(age<=70)&(female==1)), sum((bmi>=27.5)&(bmi<=32.5)&(age>70)&(female==1)),
                      sum((bmi>=32.5)&(bmi<=37.5)&(age>40)&(female==0)), sum((bmi>=32.5)&(bmi<=37.5)&(age>40)&(age<=50)&(female==0)), sum((bmi>=32.5)&(bmi<=37.5)&(age>50)&(age<=60)&(female==0)), sum((bmi>=32.5)&(bmi<=37.5)&(age>60)&(age<=70)&(female==0)), sum((bmi>=32.5)&(bmi<=37.5)&(age>70)&(female==0)),
                      sum((bmi>=32.5)&(bmi<=37.5)&(age>40)&(female==1)), sum((bmi>=32.5)&(bmi<=37.5)&(age>40)&(age<=50)&(female==1)), sum((bmi>=32.5)&(bmi<=37.5)&(age>50)&(age<=60)&(female==1)), sum((bmi>=32.5)&(bmi<=37.5)&(age>60)&(age<=70)&(female==1)), sum((bmi>=32.5)&(bmi<=37.5)&(age>70)&(female==1)),
                      sum((bmi>=37.5)&(bmi<=42.5)&(age>40)&(female==0)), sum((bmi>=37.5)&(bmi<=42.5)&(age>40)&(age<=50)&(female==0)), sum((bmi>=37.5)&(bmi<=42.5)&(age>50)&(age<=60)&(female==0)), sum((bmi>=37.5)&(bmi<=42.5)&(age>60)&(age<=70)&(female==0)), sum((bmi>=37.5)&(bmi<=42.5)&(age>70)&(female==0)),
                      sum((bmi>=37.5)&(bmi<=42.5)&(age>40)&(female==1)), sum((bmi>=37.5)&(bmi<=42.5)&(age>40)&(age<=50)&(female==1)), sum((bmi>=37.5)&(bmi<=42.5)&(age>50)&(age<=60)&(female==1)), sum((bmi>=37.5)&(bmi<=42.5)&(age>60)&(age<=70)&(female==1)), sum((bmi>=37.5)&(bmi<=42.5)&(age>70)&(female==1)),
                      sum((bmi>=42.5)&(bmi<=47.5)&(age>40)&(female==0)), sum((bmi>=42.5)&(bmi<=47.5)&(age>40)&(age<=50)&(female==0)), sum((bmi>=42.5)&(bmi<=47.5)&(age>50)&(age<=60)&(female==0)), sum((bmi>=42.5)&(bmi<=47.5)&(age>60)&(age<=70)&(female==0)), sum((bmi>=42.5)&(bmi<=47.5)&(age>70)&(female==0)),
                      sum((bmi>=42.5)&(bmi<=47.5)&(age>40)&(female==1)), sum((bmi>=42.5)&(bmi<=47.5)&(age>40)&(age<=50)&(female==1)), sum((bmi>=42.5)&(bmi<=47.5)&(age>50)&(age<=60)&(female==1)), sum((bmi>=42.5)&(bmi<=47.5)&(age>60)&(age<=70)&(female==1)), sum((bmi>=42.5)&(bmi<=47.5)&(age>70)&(female==1)),
                      sum((bmi>=47.5)&(age>40)&(female==0)), sum((bmi>=47.5)&(age>40)&(age<=50)&(female==0)), sum((bmi>=47.5)&(age>50)&(age<=60)&(female==0)), sum((bmi>=47.5)&(age>60)&(age<=70)&(female==0)), sum((bmi>=47.5)&(age>70)&(female==0)),
                      sum((bmi>=47.5)&(age>40)&(female==1)), sum((bmi>=47.5)&(age>40)&(age<=50)&(female==1)), sum((bmi>=47.5)&(age>50)&(age<=60)&(female==1)), sum((bmi>=47.5)&(age>60)&(age<=70)&(female==1)), sum((bmi>=47.5)&(age>70)&(female==1))),ncol=10,nrow=6)

comp_util_obese = sum(util_obese*dist_obese/(sum(dist_obese)))

util_chd = 1-c(.432, .074, .033, .08, .167, .224, .014, .041, .072, .179)
dist_chd = c(2/28, 25/28, 1/3, 1/3, 1/3, 1, 1, 1/3, 1/3, 1/3)
comp_util_chd = sum(util_chd*dist_chd/(sum(dist_chd)))

util_str = 1-c(.019, .070, .316, .552, .588)
dist_str = c(1/5, 1/5, 1/5, 1/5, 1/5)
comp_util_str = sum(util_str*dist_str/(sum(dist_str)))

util_dm = 1-c(0, .133, .104, .024, .571)
dist_dm = c(0.8, .08, .12/3, .12/3, .12/3)
comp_util_dm = sum(util_dm*dist_dm/(sum(dist_dm)))

util_ckd = 1-c(0, 0, 0, .104, .024, .571)
dist_ckd = c((0.199-0.001)/3, (0.199-0.001)/3,(0.199-0.001)/3, 0.1029/100/3, 0.1029/100/3, 0.1029/100/3) #https://nccd.cdc.gov/CKD/detail.aspx?Qnum=Q372
comp_util_ckd  = sum(util_ckd *dist_ckd /(sum(dist_ckd )))

comp_util_den = 0.01


qalys = (1*(1-prev_obese)+comp_util_obese*prev_obese+
  1*(1-prev_chd)+comp_util_chd*prev_chd+
  1*(1-prev_str)+comp_util_str*prev_str+
  1*(1-prev_dm)+comp_util_dm*prev_dm+
  1*(1-prev_ckd)+comp_util_ckd*prev_ckd+
  1*(1-prev_den)+comp_util_den*prev_den)/6*alive
qalys_post = (1*(1-prev_obese_post)+comp_util_obese*prev_obese_post+
           1*(1-prev_chd_post)+comp_util_chd*prev_chd_post+
           1*(1-prev_str_post)+comp_util_str*prev_str_post+
           1*(1-prev_dm_post)+comp_util_dm*prev_dm_post+
           1*(1-prev_ckd_post)+comp_util_ckd*prev_ckd_post+
           1*(1-prev_den_post)+comp_util_den*prev_den_post)/6*alive_post

costs_obese = 1429*1.27 #2006 costs updated to 2019, Exhibit 1 of: https://www.healthaffairs.org/doi/pdf/10.1377/hlthaff.28.5.w822
costs_chd = 3966*1.08 # 2015 costs updated to 2019; from MEPS: https://meps.ahrq.gov/mepstrends/hc_cond/
costs_str = 7149*1.08 # insufficient sample from employed, using not employed stat
costs_dm = 2700*1.08
costs_ckd = 4497*1.08
costs_den = 1467*1.06 #2016 costs updated to 2019; https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5010502/

costs = (costs_obese*prev_obese+
           costs_chd*prev_chd+
           costs_str*prev_str+
           costs_dm*prev_dm+
           costs_ckd*prev_ckd+
           costs_den*prev_den)/6*alive
costs_post = (costs_obese*prev_obese_post+
           costs_chd*prev_chd_post+
           costs_str*prev_str_post+
           costs_dm*prev_dm_post+
           costs_ckd*prev_ckd_post+
           costs_den*prev_den_post)/6*alive_post


discount = matrix(rep((1/(1.03^(1:yrs))),length(imp_nhanes$SEQN)),ncol=yrs,byrow=T) # discounting and integration, 10 years and lifetime

# attrition rate for private employers [applies only to 10-year employer perspective] = 23%, https://www.imercer.com/content/article/employee-turnover.aspx
tot_qalys_10[j] = sum((qalys[,1:10])*discount[,1:10])*(1-.23)/dim(qalys)[1]*10000 # per 10k
tot_costs_10[j] = sum((costs[,1:10])*discount[,1:10])*(1-.23)/dim(costs)[1]*10000
tot_qalys_lt[j] = sum((qalys)*discount)/dim(qalys)[1]*10000
tot_costs_lt[j] = sum((costs)*discount)/dim(costs)[1]*10000

tot_qalys_10_post[j] = sum((qalys_post[,1:10])*discount[,1:10])*(1-.23)/dim(qalys_post)[1]*10000
tot_costs_10_post[j] = sum((costs_post[,1:10])*discount[,1:10])*(1-.23)/dim(costs_post)[1]*10000
tot_qalys_lt_post[j] = sum((qalys_post)*discount)/dim(qalys_post)[1]*10000
tot_costs_lt_post[j] = sum((costs_post)*discount)/dim(costs_post)[1]*10000

icer_10[j] = (tot_costs_10_post[j]-tot_costs_10[j])/(tot_qalys_10_post[j]-tot_qalys_10[j])
icer_lt[j] = (tot_costs_lt_post[j]-tot_costs_lt[j])/(tot_qalys_lt_post[j]-tot_qalys_lt[j])
}
end = Sys.time() - start
print(end)
```

# summary stats

```{r summary}

dfsub = cbind(obese_cost_pre, 
chd_cost_pre, 
str_cost_pre, 
dm_cost_pre, 
ckd_cost_pre, 
den_cost_pre, 
obese_cost_post, 
chd_cost_post, 
str_cost_post, 
dm_cost_post, 
ckd_cost_post, 
den_cost_post, 
obese_cost_postmpre, 
chd_cost_postmpre, 
str_cost_postmpre, 
dm_cost_postmpre, 
ckd_cost_postmpre, 
den_cost_postmpre, 
obese_cost_pre_class , 
chd_cost_pre_class , 
str_cost_pre_class , 
dm_cost_pre_class , 
ckd_cost_pre_class , 
den_cost_pre_class , 
obese_cost_post_class , 
chd_cost_post_class , 
str_cost_post_class , 
dm_cost_post_class , 
ckd_cost_post_class , 
den_cost_poso_class , 
obese_cost_postmpre_class , 
chd_cost_postmpre_class , 
str_cost_postmpre_class , 
dm_cost_postmpre_class , 
ckd_cost_postmpre_class , 
den_cost_postmpre_class , 
obese_qalys_pre, 
chd_qalys_pre, 
str_qalys_pre, 
dm_qalys_pre, 
ckd_qalys_pre, 
den_qalys_pre, 
obese_qalys_post, 
chd_qalys_post, 
str_qalys_post, 
dm_qalys_post, 
ckd_qalys_post, 
den_qalys_post, 
obese_qalys_postmpre, 
chd_qalys_postmpre, 
str_qalys_postmpre, 
dm_qalys_postmpre, 
ckd_qalys_postmpre, 
den_qalys_postmpre, 
obese_qalys_pre_class , 
chd_qalys_pre_class , 
str_qalys_pre_class , 
dm_qalys_pre_class , 
ckd_qalys_pre_class , 
den_qalys_pre_class , 
obese_qalys_post_class , 
chd_qalys_post_class , 
str_qalys_post_class , 
dm_qalys_post_class , 
ckd_qalys_post_class , 
den_qalys_poso_class , 
obese_qalys_postmpre_class , 
chd_qalys_postmpre_class , 
str_qalys_postmpre_class , 
dm_qalys_postmpre_class , 
ckd_qalys_postmpre_class , 
den_qalys_postmpre_class , 
qalys_pre, 
qalys_post, 
qalys_postmpre, 
costs_pre, 
costs_post, 
costs_postmpre, 
qalys_pre_class, 
qalys_post_class, 
qalys_postmpre_class, 
costs_pre_class, 
costs_post_class, 
costs_postmpre_class)
colMeans(dfsub)
colSds(dfsub)
readr::write_csv(as.data.frame(dfsub), path = "dfsub.csv")

df = (cbind(tot_qalys_10,tot_costs_10, tot_qalys_lt, tot_costs_lt, tot_qalys_10_post, tot_costs_10_post, tot_qalys_lt_post, tot_costs_lt_post, icer_10, icer_lt))
colMeans(df)
colSds(df)
readr::write_csv(as.data.frame(df), path = "df.csv")

```
